# CVE-Search MCP Server Docker Image
# Based on https://github.com/roadwy/cve-search_mcp
FROM python:3.11-slim

LABEL maintainer="MrLYC"
LABEL description="CVE-Search MCP Server - A Model Context Protocol server for querying CVE-Search API"
LABEL source="https://github.com/roadwy/cve-search_mcp"

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    git \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# 从源码仓库克隆项目
RUN git clone https://github.com/roadwy/cve-search_mcp.git . 

# 创建虚拟环境并安装依赖
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# 安装 FastMCP 和其他依赖
RUN pip install --no-cache-dir \
    fastmcp \
    requests \
    && pip install --no-cache-dir -e .

# 创建非 root 用户
RUN groupadd -r mcpuser && useradd -r -g mcpuser -d /app -s /bin/bash mcpuser && \
    chown -R mcpuser:mcpuser /app /opt/venv

# 切换到非 root 用户
USER mcpuser

# 暴露端口（虽然 MCP 服务器通常不需要网络端口，但为了扩展性）
EXPOSE 8080

# 设置环境变量
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV PATH="/opt/venv/bin:$PATH"

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import main; print('MCP server is ready')" || exit 1

# 默认命令
CMD ["python", "main.py"]